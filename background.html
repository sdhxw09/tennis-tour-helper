<script type="text/javascript" src="jquery-1.7.1.min.js"></script>

<script>
    var meboss = {
        currentTabId: 0,

        addMessageListener: function() {
            chrome.tabs.onSelectionChanged.addListener(function (tabId) {
                meboss.currentTabId = tabId;
                chrome.tabs.get(tabId, function(tab) {
                    var tabUrl = tab.url;
                    console.log(tabUrl);
                    if (tabUrl.indexOf('http://tennislink.usta.com/') != -1) {
                        chrome.pageAction.show(meboss.currentTabId);
                    }
                });
            });

            chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
                var option = request.option;
                if (option === "RANKING") {
                    var rankingData = request.data;

                    var rankingPopupData = [];
                    var keys = Object.keys(rankingData);
                    for (var i = 0; i < keys.length; i++) {
                        var key = keys[i];
                        var myRanking = [key, rankingData[key]];
                        rankingPopupData.push(myRanking);
                    }

                    meboss.saveRanking(rankingPopupData);
                    chrome.extension.getViews({type: 'popup'})[0].meboss.refreshRanking(rankingPopupData);
                }
                else {
                    var applicantData = request.data;
                    var  applicantPopupData = [];
                    for (var i = 0; i < applicantData.length; i++) {
                        var name = applicantData[i];
                        var myRanking = [name, meboss.findRanking(name)];
                        applicantPopupData.push(myRanking);
                    }

                    applicantPopupData.sort(function(a, b) {
                        return a[1] - b[1];
                    });

                    chrome.extension.getViews({type: 'popup'})[0].meboss.refreshApplicant(applicantPopupData);
                }
            });
        },

        refreshRanking: function() {
            chrome.tabs.sendRequest(meboss.currentTabId, {'option': 'RANKING'});
        },

        setApplicantRanking: function() {
            chrome.tabs.sendRequest(meboss.currentTabId, {'option': 'APPLICANT'});
        },

        saveRanking: function(rankingPopupData) {
            localStorage.clear();
            localStorage.setItem('RANKING', JSON.stringify(rankingPopupData));
            localStorage.setItem('TIMESTAMP', Date.now());
        },

        findRanking: function(name) {
            var ranking = '';
            var rankingData = JSON.parse(localStorage.getItem('RANKING'));
            if (rankingData) {
                for (var i = 0; i < rankingData.length; i++) {
                    var playerName = rankingData[i][0];
                    if (playerName.indexOf(name) != -1) {
                        ranking = rankingData[i][1];
                        break;
                    }
                }
            }

            return ranking;
        }
    };

    meboss.addMessageListener();
</script>
