<script type="text/javascript" src="jquery-1.7.1.min.js"></script>

<script>
    var meboss = {
        currentTabId: 0,
        ageGroup: 'B14',

        addMessageListener: function() {
            chrome.tabs.onSelectionChanged.addListener(function (tabId) {
                meboss.currentTabId = tabId;
                chrome.tabs.get(tabId, function(tab) {
                    var tabUrl = tab.url;
                    console.log(tabUrl);
                    if (tabUrl.indexOf('http://tennislink.usta.com/') != -1) {
                        chrome.pageAction.show(meboss.currentTabId);
                    }
                });
            });

            chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
                var option = request.option;
                if (option === "RANKING") {
                    var playerData = request.data;

                    var rankingPopupData = [];
                    var names = Object.keys(playerData);
                    for (var i = 0; i < names.length; i++) {
                        var name = names[i];
                        var myRanking = [name, playerData[name][0], playerData[name][1]];   //[name, ranking, state]
                        rankingPopupData.push(myRanking);
                    }

                    meboss.saveRanking(meboss.ageGroup, rankingPopupData);
                    chrome.extension.getViews({type: 'popup'})[0].meboss.refreshRanking(meboss.ageGroup, rankingPopupData);
                }
                else {
                    var applicantData = request.data;
                    var  applicantPopupData = [];
                    for (var i = 0; i < applicantData.length; i++) {
                        var name = applicantData[i];

                        var playerInfo = meboss.findRanking('B14', name);
                        if (playerInfo.length != 0) {
                            applicantPopupData.push([name, playerInfo[0], playerInfo[1]]);
                        }
                        else {
                            applicantPopupData.push([name, '', '']);
                        }
                    }

                    applicantPopupData.sort(function(a, b) {
                        return a[1] - b[1];
                    });

                    chrome.extension.getViews({type: 'popup'})[0].meboss.refreshApplicant(applicantPopupData);
                }
            });
        },

        refreshB14Ranking: function() {
            meboss.ageGroup = 'B14';
            chrome.tabs.sendRequest(meboss.currentTabId, {'option': 'RANKING'});
        },

        refreshB12Ranking: function() {
            meboss.ageGroup = 'B12';
            chrome.tabs.sendRequest(meboss.currentTabId, {'option': 'RANKING'});
        },

        setApplicantRanking: function() {
            chrome.tabs.sendRequest(meboss.currentTabId, {'option': 'APPLICANT'});
        },

        saveRanking: function(ageGroup, rankingPopupData) {
            localStorage.setItem(ageGroup, JSON.stringify(rankingPopupData));
            localStorage.setItem('TIMESTAMP', Date.now());
        },

        findRanking: function(ageGroup, name) {
            var ranking = [];
            var playerData = JSON.parse(localStorage.getItem(ageGroup));
            if (playerData) {
                for (var i = 0; i < playerData.length; i++) {
                    var playerName = playerData[i][0];
                    if (playerName.indexOf(name) != -1) {
                        ranking = [playerData[i][1], playerData[i][2]];
                        break;
                    }
                }
            }

            return ranking;
        }
    };

    meboss.addMessageListener();
</script>
